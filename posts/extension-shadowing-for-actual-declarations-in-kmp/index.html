<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Extension Shadowing for Actual Declarations in KMP |</title><meta name=keywords content="android,kotlin,kmp"><meta name=description content="Heads-up: this article assumes familiarity with Kotlin&rsquo;s extension functions and expect and actual declarations in Kotlin Multiplatform (KMP).
My work has recently focused on &ldquo;commonizing&rdquo;1 APIs, and I came across KT-70012, which I believe merits attention.
In Kotlin JVM development, the EXTENSION_SHADOWED_BY_MEMBER warning indicates that an extension function is redundant, as it will always be overshadowed by a member function with the same name when invoked. However, in KMP, this behaviour can be useful, as shadowing may occur on some platforms but not all."><meta name=author content><link rel=canonical href=https://marcellogalhardo.dev/posts/extension-shadowing-for-actual-declarations-in-kmp/><link crossorigin=anonymous href=/assets/css/stylesheet.fc220c15db4aef0318bbf30adc45d33d4d7c88deff3238b23eb255afdc472ca6.css integrity="sha256-/CIMFdtK7wMYu/MK3EXTPU18iN7/MjiyPrJVr9xHLKY=" rel="preload stylesheet" as=style><link rel=icon href=https://marcellogalhardo.dev/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://marcellogalhardo.dev/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://marcellogalhardo.dev/favicon-32x32.png><link rel=apple-touch-icon href=https://marcellogalhardo.dev/apple-touch-icon.png><link rel=mask-icon href=https://marcellogalhardo.dev/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-7LK7ENB813"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-7LK7ENB813",{anonymize_ip:!1})}</script><meta property="og:title" content="Extension Shadowing for Actual Declarations in KMP"><meta property="og:description" content="Heads-up: this article assumes familiarity with Kotlin&rsquo;s extension functions and expect and actual declarations in Kotlin Multiplatform (KMP).
My work has recently focused on &ldquo;commonizing&rdquo;1 APIs, and I came across KT-70012, which I believe merits attention.
In Kotlin JVM development, the EXTENSION_SHADOWED_BY_MEMBER warning indicates that an extension function is redundant, as it will always be overshadowed by a member function with the same name when invoked. However, in KMP, this behaviour can be useful, as shadowing may occur on some platforms but not all."><meta property="og:type" content="article"><meta property="og:url" content="https://marcellogalhardo.dev/posts/extension-shadowing-for-actual-declarations-in-kmp/"><meta property="og:image" content="https://marcellogalhardo.dev/logo.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-11-07T15:49:00+01:00"><meta property="article:modified_time" content="2024-11-07T15:49:00+01:00"><meta property="og:site_name" content="Marcello Galhardo"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://marcellogalhardo.dev/logo.png"><meta name=twitter:title content="Extension Shadowing for Actual Declarations in KMP"><meta name=twitter:description content="Heads-up: this article assumes familiarity with Kotlin&rsquo;s extension functions and expect and actual declarations in Kotlin Multiplatform (KMP).
My work has recently focused on &ldquo;commonizing&rdquo;1 APIs, and I came across KT-70012, which I believe merits attention.
In Kotlin JVM development, the EXTENSION_SHADOWED_BY_MEMBER warning indicates that an extension function is redundant, as it will always be overshadowed by a member function with the same name when invoked. However, in KMP, this behaviour can be useful, as shadowing may occur on some platforms but not all."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://marcellogalhardo.dev/posts/"},{"@type":"ListItem","position":2,"name":"Extension Shadowing for Actual Declarations in KMP","item":"https://marcellogalhardo.dev/posts/extension-shadowing-for-actual-declarations-in-kmp/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Extension Shadowing for Actual Declarations in KMP","name":"Extension Shadowing for Actual Declarations in KMP","description":"Heads-up: this article assumes familiarity with Kotlin\u0026rsquo;s extension functions and expect and actual declarations in Kotlin Multiplatform (KMP).\nMy work has recently focused on \u0026ldquo;commonizing\u0026rdquo;1 APIs, and I came across KT-70012, which I believe merits attention.\nIn Kotlin JVM development, the EXTENSION_SHADOWED_BY_MEMBER warning indicates that an extension function is redundant, as it will always be overshadowed by a member function with the same name when invoked. However, in KMP, this behaviour can be useful, as shadowing may occur on some platforms but not all.","keywords":["android","kotlin","kmp"],"articleBody":"Heads-up: this article assumes familiarity with Kotlin’s extension functions and expect and actual declarations in Kotlin Multiplatform (KMP).\nMy work has recently focused on “commonizing”1 APIs, and I came across KT-70012, which I believe merits attention.\nIn Kotlin JVM development, the EXTENSION_SHADOWED_BY_MEMBER warning indicates that an extension function is redundant, as it will always be overshadowed by a member function with the same name when invoked. However, in KMP, this behaviour can be useful, as shadowing may occur on some platforms but not all.\nStarting with Kotlin 2.1.0-Beta1, this warning will be removed in such cases. While this won’t change any behaviour, it will validate shadowing as a legitimate use case for KMP.\nThis allows for effective strategies when commonizing existing APIs that need to remain backwards compatible, especially those not initially developed with Kotlin in mind.\nLet’s explore a naive use case for Android: Bundle.putBoolean(String?, Boolean)\n// Common expect class Bundle expect fun Bundle.putBoolean(key: String, value: Boolean) // Android actual typealias Bundle = android.os.Bundle actual inline fun Bundle.putBoolean(key: String, value: Boolean) { error(\"Extension shadowed by member\") } // Non-Android actual class Bundle(map: Map) actual fun Bundle.putBoolean(key: String, value: Boolean) { map[key] = value } Let’s break this down:\nexpect class Bundle is an opaque type with no members in commonMain. expect fun Bundle.putBoolean(key, value) matches the signature of the original putBoolean method, but changes the first parameter from String? to String. With this setup:\nOn Android, putBoolean won’t exist at runtime and will always be superseded by the original member function. On other platforms, the extension function will be utilized instead. It enables stricter types for shadowed members (e.g., changing key: String? to key: String since the types are compatible). The new type alias remains backward compatible with existing APIs. The EXTENSION_SHADOWED_BY_MEMBER warning is expected to be removed in Kotlin version 2.1.0. I hope to see more documentation on extension shadowing for actual declarations and clarification on what we can expect from the final bytecode on platforms where methods are shadowed.\nFor now, however, it remains an interesting concept to explore in side projects.\nCommonization refers to making an API available in the Kotlin Multiplatform common source sets across multiple platforms. ↩︎\n","wordCount":"363","inLanguage":"en","image":"https://marcellogalhardo.dev/logo.png","datePublished":"2024-11-07T15:49:00+01:00","dateModified":"2024-11-07T15:49:00+01:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://marcellogalhardo.dev/posts/extension-shadowing-for-actual-declarations-in-kmp/"},"publisher":{"@type":"Organization","name":"","logo":{"@type":"ImageObject","url":"https://marcellogalhardo.dev/favicon.ico"}}}</script></head><body class=dark id=top><header class=header><nav class=nav><div class=logo><div class=logo-switches></div></div><ul id=menu><li><a href=https://marcellogalhardo.dev/posts/ title=Posts><span>Posts</span></a></li><li><a href=https://marcellogalhardo.dev/talks title=Talks><span>Talks</span></a></li><li><a href=https://marcellogalhardo.dev/about title=About><span>About</span></a></li><li><a href=https://marcellogalhardo.dev/uses title=Uses><span>Uses</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">Extension Shadowing for Actual Declarations in KMP</h1><div class=post-meta><span title='2024-11-07 15:49:00 +0100 +0100'>November 7, 2024</span></div></header><div class=post-content><p><strong>Heads-up:</strong> this article assumes familiarity with Kotlin&rsquo;s <a href=https://kotlinlang.org/docs/extensions.html>extension functions</a> and <a href=https://kotlinlang.org/docs/multiplatform-expect-actual.html>expect and actual declarations</a> in <a href=https://kotlinlang.org/docs/multiplatform.html>Kotlin Multiplatform (KMP)</a>.</p><p>My work has recently focused on &ldquo;commonizing&rdquo;<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup> APIs, and I came across <a href=https://youtrack.jetbrains.com/issue/KT-70012/EXTENSIONSHADOWEDBYMEMBER-shouldnt-be-reported-for-actual-declarations>KT-70012</a>, which I believe merits attention.</p><p>In Kotlin JVM development, the <code>EXTENSION_SHADOWED_BY_MEMBER</code> warning indicates that an extension function is redundant, as it will always be overshadowed by a member function with the same name when invoked. However, in <a href=https://kotlinlang.org/docs/multiplatform.html>KMP</a>, this behaviour can be useful, as shadowing may occur on some platforms but not all.</p><p>Starting with Kotlin 2.1.0-Beta1, this warning will be removed in such cases. While this won&rsquo;t change any behaviour, it will validate shadowing as a legitimate use case for <a href=https://kotlinlang.org/docs/multiplatform.html>KMP</a>.</p><p>This allows for effective strategies when commonizing existing APIs that need to remain backwards compatible, especially those not initially developed with Kotlin in mind.</p><p>Let&rsquo;s explore a naive use case for Android: <a href=https://developer.android.com/reference/android/os/BaseBundle#putBoolean(java.lang.String,%20boolean)>Bundle.putBoolean(String?, Boolean)</a></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#75715e>// Common
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>expect</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Bundle</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>expect</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>Bundle</span>.putBoolean(key: String, <span style=color:#66d9ef>value</span>: Boolean)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Android
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>actual</span> <span style=color:#66d9ef>typealias</span> Bundle = android.os.Bundle
</span></span><span style=display:flex><span><span style=color:#66d9ef>actual</span> <span style=color:#66d9ef>inline</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>Bundle</span>.putBoolean(key: String, <span style=color:#66d9ef>value</span>: Boolean) {
</span></span><span style=display:flex><span>  error(<span style=color:#e6db74>&#34;Extension shadowed by member&#34;</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Non-Android
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>actual</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Bundle</span>(map: Map&lt;String, Any?&gt;)
</span></span><span style=display:flex><span><span style=color:#66d9ef>actual</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>Bundle</span>.putBoolean(key: String, <span style=color:#66d9ef>value</span>: Boolean) {
</span></span><span style=display:flex><span>    map[key] = <span style=color:#66d9ef>value</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Let’s break this down:</p><ol><li><code>expect class Bundle</code> is an opaque type with no members in <code>commonMain</code>.</li><li><code>expect fun Bundle.putBoolean(key, value)</code> matches the signature of the original <code>putBoolean</code> method, but changes the first parameter from <code>String?</code> to <code>String</code>.</li></ol><p>With this setup:</p><ul><li>On Android, <code>putBoolean</code> won&rsquo;t exist at runtime and will always be superseded by the original member function.</li><li>On other platforms, the extension function will be utilized instead.</li><li>It enables stricter types for shadowed members (e.g., changing <code>key: String?</code> to <code>key: String</code> since the types are compatible).</li><li>The new type alias remains backward compatible with existing APIs.</li></ul><p><img loading=lazy src=/images/extension-shadowing-for-actual-declarations-in-kmp.png alt=extension-shadowing-for-actual-declarations-in-kmp></p><p>The <code>EXTENSION_SHADOWED_BY_MEMBER</code> warning is expected to be removed in Kotlin version 2.1.0. I hope to see more documentation on extension shadowing for actual declarations and clarification on what we can expect from the final bytecode on platforms where methods are shadowed.</p><p>For now, however, it remains an interesting concept to explore in side projects.</p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>Commonization refers to making an API available in the Kotlin Multiplatform <code>common</code> source sets across multiple platforms.&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://marcellogalhardo.dev/tags/android/>android</a></li><li><a href=https://marcellogalhardo.dev/tags/kotlin/>kotlin</a></li><li><a href=https://marcellogalhardo.dev/tags/kmp/>kmp</a></li></ul></footer></article></main><footer class=footer><span>&copy; 2024 <a href=https://marcellogalhardo.dev/></a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script></body></html>