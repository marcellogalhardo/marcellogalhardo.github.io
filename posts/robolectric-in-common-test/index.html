<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Robolectric in commonTest | Marcello Galhardo</title>
<meta name=keywords content="android,kotlin,kmp"><meta name=description content="Sharing tests across Kotlin Multiplatform (KMP) projects can be tricky when dealing with platform-specific APIs like Android&rsquo;s Bundle. commonTest on Android relies on the androidTest source set, which uses an empty android.jar, leading to test failures.
The Solution The ideal solution is to avoid platform-specific APIs in commonTest. However, if that’s not an option, you can use Robolectric in your commonTest source set to access functional Android classes. This approach:"><meta name=author content><link rel=canonical href=https://marcellogalhardo.dev/posts/robolectric-in-common-test/><link crossorigin=anonymous href=/assets/css/stylesheet.fc220c15db4aef0318bbf30adc45d33d4d7c88deff3238b23eb255afdc472ca6.css integrity="sha256-/CIMFdtK7wMYu/MK3EXTPU18iN7/MjiyPrJVr9xHLKY=" rel="preload stylesheet" as=style><link rel=icon href=https://marcellogalhardo.dev/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://marcellogalhardo.dev/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://marcellogalhardo.dev/favicon-32x32.png><link rel=apple-touch-icon href=https://marcellogalhardo.dev/apple-touch-icon.png><link rel=mask-icon href=https://marcellogalhardo.dev/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://marcellogalhardo.dev/posts/robolectric-in-common-test/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-7LK7ENB813"></script><script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-7LK7ENB813",{anonymize_ip:!1})}</script><meta property="og:title" content="Robolectric in commonTest"><meta property="og:description" content="Sharing tests across Kotlin Multiplatform (KMP) projects can be tricky when dealing with platform-specific APIs like Android&rsquo;s Bundle. commonTest on Android relies on the androidTest source set, which uses an empty android.jar, leading to test failures.
The Solution The ideal solution is to avoid platform-specific APIs in commonTest. However, if that’s not an option, you can use Robolectric in your commonTest source set to access functional Android classes. This approach:"><meta property="og:type" content="article"><meta property="og:url" content="https://marcellogalhardo.dev/posts/robolectric-in-common-test/"><meta property="og:image" content="https://marcellogalhardo.dev/logo.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-11-28T16:15:00+01:00"><meta property="article:modified_time" content="2024-11-28T16:15:00+01:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://marcellogalhardo.dev/logo.png"><meta name=twitter:title content="Robolectric in commonTest"><meta name=twitter:description content="Sharing tests across Kotlin Multiplatform (KMP) projects can be tricky when dealing with platform-specific APIs like Android&rsquo;s Bundle. commonTest on Android relies on the androidTest source set, which uses an empty android.jar, leading to test failures.
The Solution The ideal solution is to avoid platform-specific APIs in commonTest. However, if that’s not an option, you can use Robolectric in your commonTest source set to access functional Android classes. This approach:"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://marcellogalhardo.dev/posts/"},{"@type":"ListItem","position":2,"name":"Robolectric in commonTest","item":"https://marcellogalhardo.dev/posts/robolectric-in-common-test/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Robolectric in commonTest","name":"Robolectric in commonTest","description":"Sharing tests across Kotlin Multiplatform (KMP) projects can be tricky when dealing with platform-specific APIs like Android\u0026rsquo;s Bundle. commonTest on Android relies on the androidTest source set, which uses an empty android.jar, leading to test failures.\nThe Solution The ideal solution is to avoid platform-specific APIs in commonTest. However, if that’s not an option, you can use Robolectric in your commonTest source set to access functional Android classes. This approach:","keywords":["android","kotlin","kmp"],"articleBody":"Sharing tests across Kotlin Multiplatform (KMP) projects can be tricky when dealing with platform-specific APIs like Android’s Bundle. commonTest on Android relies on the androidTest source set, which uses an empty android.jar, leading to test failures.\nThe Solution The ideal solution is to avoid platform-specific APIs in commonTest. However, if that’s not an option, you can use Robolectric in your commonTest source set to access functional Android classes. This approach:\nAllows testing of platform-specific code in commonTest. Eliminates the need to duplicate tests in androidTest. How It’s Done Add the Robolectric dependency to your androidTest : implementation(\"org.robolectric:robolectric:4.14\") Use expect/actual to provide platform-specific abstract class RobolectricTest. In commonTest, define the expect class:\nexpect abstract class RobolectricTest() In androidTest, provide the actual implementation using Robolectric:\n@RunWith(RobolectricTestRunner::class) @Config(manifest = Config.NONE) actual abstract class RobolectricTest actual constructor() For other platforms, provide an empty actual implementation:\nactual abstract class RobolectricTest actual constructor() Write your tests in commonTest extending the expected declaration. class SavedStateTest : RobolectricTest() That’s It Robolectric will simulate the Android environment and allow a commonTest to run platform-specific code.\nReferences commonTest/androidx/savedstate/SavedStateTest.kt commonTest/androidx/savedstate/RobolectricTest.kt androidUnitTest/androidx/savedstate/RobolectricTest.android.kt nonAndroidTest/androidx/savedstate/RobolectricTest.nonAndroid.kt ","wordCount":"181","inLanguage":"en","image":"https://marcellogalhardo.dev/logo.png","datePublished":"2024-11-28T16:15:00+01:00","dateModified":"2024-11-28T16:15:00+01:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://marcellogalhardo.dev/posts/robolectric-in-common-test/"},"publisher":{"@type":"Organization","name":"Marcello Galhardo","logo":{"@type":"ImageObject","url":"https://marcellogalhardo.dev/favicon.ico"}}}</script></head><body class=dark id=top><header class=header><nav class=nav><div class=logo><a href=https://marcellogalhardo.dev/ accesskey=h title="Marcello Galhardo (Alt + H)">Marcello Galhardo</a><div class=logo-switches></div></div><ul id=menu><li><a href=https://marcellogalhardo.dev/posts/ title=Posts><span>Posts</span></a></li><li><a href=https://marcellogalhardo.dev/talks title=Talks><span>Talks</span></a></li><li><a href=https://marcellogalhardo.dev/about title=About><span>About</span></a></li><li><a href=https://marcellogalhardo.dev/uses title=Uses><span>Uses</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">Robolectric in commonTest</h1><div class=post-meta><span title='2024-11-28 16:15:00 +0100 +0100'>November 28, 2024</span></div></header><div class=post-content><p>Sharing tests across Kotlin Multiplatform (KMP) projects can be tricky when dealing with platform-specific APIs like Android&rsquo;s <code>Bundle</code>. <code>commonTest</code> on Android relies on the <code>androidTest</code> source set, which uses an empty <code>android.jar</code>, leading to test failures.</p><h3 id=the-solution>The Solution<a hidden class=anchor aria-hidden=true href=#the-solution>#</a></h3><p>The ideal solution is to avoid platform-specific APIs in <code>commonTest</code>. However, if that’s not an option, you can use Robolectric in your <code>commonTest</code> source set to access functional Android classes. This approach:</p><ul><li>Allows testing of platform-specific code in <code>commonTest</code>.</li><li>Eliminates the need to duplicate tests in <code>androidTest</code>.</li></ul><h3 id=how-its-done>How It’s Done<a hidden class=anchor aria-hidden=true href=#how-its-done>#</a></h3><ol><li>Add the Robolectric dependency to your <code>androidTest</code> :</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-groovy data-lang=groovy><span style=display:flex><span>implementation<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;org.robolectric:robolectric:4.14&#34;</span><span style=color:#f92672>)</span>
</span></span></code></pre></div><ol start=2><li>Use <code>expect</code>/<code>actual</code> to provide platform-specific <code>abstract class RobolectricTest</code>.</li></ol><p>In <code>commonTest</code>, define the expect class:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#66d9ef>expect</span> <span style=color:#66d9ef>abstract</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>RobolectricTest</span>()
</span></span></code></pre></div><p>In <code>androidTest</code>, provide the actual implementation using <code>Robolectric</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#a6e22e>@RunWith</span>(RobolectricTestRunner<span style=color:#f92672>::</span><span style=color:#66d9ef>class</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Config</span>(manifest = <span style=color:#a6e22e>Config</span>.NONE)
</span></span><span style=display:flex><span><span style=color:#66d9ef>actual</span> <span style=color:#66d9ef>abstract</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>RobolectricTest</span> <span style=color:#66d9ef>actual</span> <span style=color:#66d9ef>constructor</span>()
</span></span></code></pre></div><p>For other platforms, provide an empty actual implementation:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#66d9ef>actual</span> <span style=color:#66d9ef>abstract</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>RobolectricTest</span> <span style=color:#66d9ef>actual</span> <span style=color:#66d9ef>constructor</span>()
</span></span></code></pre></div><ol start=3><li>Write your tests in <code>commonTest</code> extending the expected declaration.</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SavedStateTest</span> : RobolectricTest()
</span></span></code></pre></div><h3 id=thats-it>That’s It<a hidden class=anchor aria-hidden=true href=#thats-it>#</a></h3><p>Robolectric will simulate the Android environment and allow a <code>commonTest</code> to run platform-specific code.</p><h3 id=references>References<a hidden class=anchor aria-hidden=true href=#references>#</a></h3><ul><li><a href="https://cs.android.com/androidx/platform/frameworks/support/+/7dc24cd1eb1889c2b9234a32bb5852dc0d263995:savedstate/savedstate/src/commonTest/kotlin/androidx/savedstate/SavedStateTest.kt;l=23">commonTest/androidx/savedstate/SavedStateTest.kt</a></li><li><a href="https://cs.android.com/androidx/platform/frameworks/support/+/7dc24cd1eb1889c2b9234a32bb5852dc0d263995:savedstate/savedstate/src/commonTest/kotlin/androidx/savedstate/RobolectricTest.kt;l=19">commonTest/androidx/savedstate/RobolectricTest.kt</a></li><li><a href="https://cs.android.com/androidx/platform/frameworks/support/+/7dc24cd1eb1889c2b9234a32bb5852dc0d263995:savedstate/savedstate/src/androidUnitTest/kotlin/androidx/savedstate/RobolectricTest.android.kt;l=25">androidUnitTest/androidx/savedstate/RobolectricTest.android.kt</a></li><li><a href=https://cs.android.com/androidx/platform/frameworks/support/+/7dc24cd1eb1889c2b9234a32bb5852dc0d263995:savedstate/savedstate/src/nonAndroidTest/kotlin/androidx/savedstate/RobolectricTest.nonAndroid.kt>nonAndroidTest/androidx/savedstate/RobolectricTest.nonAndroid.kt</a></li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://marcellogalhardo.dev/tags/android/>Android</a></li><li><a href=https://marcellogalhardo.dev/tags/kotlin/>Kotlin</a></li><li><a href=https://marcellogalhardo.dev/tags/kmp/>Kmp</a></li></ul></footer></article></main><footer class=footer><span>CC BY-NC 4.0</span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script></body></html>