<!doctype html><html lang=en>
<head>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="ie=edge">
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=author content>
<meta name=description content="Modeling is a critical task in Software Development: good models reduce the risk of bugs, increase readability and improve maintainability. However, I often see developers focusing on &amp;ldquo;How can I code this?&amp;rdquo; - and they are done when they find a way to code it. That inherently reduces the domain modeling to the abuse of primitives and shallow design where any inconsistent state is allowed.
To better explain, let&amp;rsquo;s consider the hypothetical requirements:">
<meta name=keywords content=",kotlin">
<meta name=robots content="noodp">
<meta name=theme-color content>
<link rel=canonical href=https://marcellogalhardo.dev/posts/2021/10/07/deep-models/>
<title>
Deep Models :: Marcello â€” Software Engineer (Android)
</title>
<link href=https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.5.0/css/flag-icon.min.css rel=stylesheet type=text/css>
<link rel=stylesheet href=/main.29c2c8c3fc9cf748254138351f142ac2833b208a68e83aec126edc98b59efef2.css>
<meta itemprop=name content="Deep Models">
<meta itemprop=description content="Modeling is a critical task in Software Development: good models reduce the risk of bugs, increase readability and improve maintainability. However, I often see developers focusing on &ldquo;How can I code this?&rdquo; - and they are done when they find a way to code it. That inherently reduces the domain modeling to the abuse of primitives and shallow design where any inconsistent state is allowed.
To better explain, let&rsquo;s consider the hypothetical requirements:"><meta itemprop=datePublished content="2021-10-07T09:02:50+01:00">
<meta itemprop=dateModified content="2021-10-07T09:02:50+01:00">
<meta itemprop=wordCount content="769"><meta itemprop=image content="https://marcellogalhardo.dev/">
<meta itemprop=keywords content="kotlin,">
<meta name=twitter:card content="summary_large_image">
<meta name=twitter:image content="https://marcellogalhardo.dev/">
<meta name=twitter:title content="Deep Models">
<meta name=twitter:description content="Modeling is a critical task in Software Development: good models reduce the risk of bugs, increase readability and improve maintainability. However, I often see developers focusing on &ldquo;How can I code this?&rdquo; - and they are done when they find a way to code it. That inherently reduces the domain modeling to the abuse of primitives and shallow design where any inconsistent state is allowed.
To better explain, let&rsquo;s consider the hypothetical requirements:">
<meta property="article:section" content="software development">
<meta property="article:published_time" content="2021-10-07 09:02:50 +0100 +0100">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-7LK7ENB813"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-7LK7ENB813',{anonymize_ip:!1})}</script>
</head>
<body>
<div class=container>
<header class=header>
<span class=header__inner>
<a href=/ style=text-decoration:none>
<div class=logo>
<span class=logo__mark>></span>
<span class=logo__text>marcellogalhardo.dev</span>
<span class=logo__cursor>
</span>
</div>
</a>
<span class=header__right>
<nav class=menu>
<ul class=menu__inner><li><a href=/posts/>Posts</a></li><li><a href=/talks>Talks</a></li><li><a href=/about>About</a></li><li><a href=/uses>Uses</a></li>
</ul>
</nav>
<span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
</span>
</span>
</span>
</header>
<div class=content>
<main class=post>
<div class=post-info>
<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
4 minutes
</p>
</div>
<article>
<h1 class=post-title>
<a href=https://marcellogalhardo.dev/posts/2021/10/07/deep-models/>Deep Models</a>
</h1>
<div class=post-content>
<p>Modeling is a critical task in Software Development: good models reduce the risk of bugs, increase readability and improve maintainability. However, I often see developers focusing on &ldquo;How can I code this?&rdquo; - and they are done when they find a way to code it. That inherently reduces the domain modeling to the abuse of primitives and shallow design where any inconsistent state is allowed.</p>
<p>To better explain, let&rsquo;s consider the hypothetical requirements:</p>
<ul>
<li>Your team is developing a feature to order items in e-commerce.</li>
<li>Your job is to design the models of this feature.</li>
</ul>
<p>The simplest way to do that might look like the code below.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>findOrderById</span>(id: String): Order

<span style=color:#66d9ef>data</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Order</span>(
    <span style=color:#66d9ef>val</span> id: String,
    <span style=color:#66d9ef>val</span> accountId: String,
    <span style=color:#66d9ef>val</span> items: List&lt;OrderItem&gt;,
    <span style=color:#75715e>// ...billing address, shipping address, status, and other properties.
</span><span style=color:#75715e></span>)

<span style=color:#66d9ef>data</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>OrderItem</span>(
    <span style=color:#66d9ef>val</span> id: String,
    <span style=color:#66d9ef>val</span> name: String,
    <span style=color:#66d9ef>val</span> quantity: Int,
    <span style=color:#66d9ef>val</span> price: BigDecimal,
)
</code></pre></div><p>At first glance, these models will look good, but let&rsquo;s have a closer look.</p>
<ol>
<li><a href=https://refactoring.guru/smells/primitive-obsession>Primitive Obsession</a>: almost all types are String, and the compiler is incapable of verifying their integrity.</li>
<li><a href=https://medium.com/code-design/invariants-in-code-design-557c7864a047>Absence of Invariants</a>: it is unrealistic to define a quantity as a number between <code>-2147483648</code> and <code>2147483647</code>.</li>
<li><a href="https://www.youtube.com/watch?v=t3DBzaeid74">Error Prone</a>: what happens if you create an <code>Order</code> with an empty <code>accountId</code>? What will happen if you call <code>findOrderById</code> with an <code>ItemId</code> by mistake?</li>
</ol>
<p>Good models get out of developers' way by making it impossible to be in an invalid state and by leveraging the compiler not to allow human&rsquo;s mistake (e.g., an <code>OrderItemId</code> should not be used as an <code>OrderId</code>).</p>
<p>Let&rsquo;s redesign the previous model.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>findOrderById</span>(id: OrderId): Order

<span style=color:#66d9ef>data</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Order</span>(
    <span style=color:#66d9ef>val</span> id: OrderId,
    <span style=color:#66d9ef>val</span> accountId: OrderAccountId,
    <span style=color:#66d9ef>val</span> items: List&lt;OrderItem&gt;,
)

<span style=color:#a6e22e>@JvmInline</span>
value <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>OrderId</span>(<span style=color:#66d9ef>val</span> value: String) {
    <span style=color:#66d9ef>init</span> {
        runCatching { UUID.fromString(value) }
            .onFailure { e <span style=color:#f92672>-&gt;</span> error(<span style=color:#e6db74>&#34;OrderId should be a valid UUID but found: </span><span style=color:#e6db74>$value</span><span style=color:#e6db74>.&#34;</span>) }
    }
}

<span style=color:#a6e22e>@JvmInline</span>
value <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>AccountId</span>(<span style=color:#66d9ef>val</span> value: String) {
    <span style=color:#66d9ef>init</span> {
        runCatching { UUID.fromString(value) }
            .onFailure { e <span style=color:#f92672>-&gt;</span> error(<span style=color:#e6db74>&#34;AccountId should be a valid UUID but found: </span><span style=color:#e6db74>$value</span><span style=color:#e6db74>.&#34;</span>) }
    }
}

<span style=color:#66d9ef>data</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>OrderItem</span>(
    <span style=color:#66d9ef>val</span> id: OrderItemId,
    <span style=color:#66d9ef>val</span> name: OrderItemName,
    <span style=color:#66d9ef>val</span> quantity: OrderItemQuantity,
    <span style=color:#66d9ef>val</span> price: OrderItemPrice,
)

<span style=color:#a6e22e>@JvmInline</span>
value <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>OrderItemId</span>(<span style=color:#66d9ef>val</span> value: String) {
    <span style=color:#66d9ef>init</span> {
        runCatching { UUID.fromString(value) }
            .onFailure { e <span style=color:#f92672>-&gt;</span> error(<span style=color:#e6db74>&#34;OrderItemId should be a valid UUID but found: </span><span style=color:#e6db74>$value</span><span style=color:#e6db74>.&#34;</span>) }
    }
}

<span style=color:#a6e22e>@JvmInline</span>
value <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>OrderItemName</span>(<span style=color:#66d9ef>val</span> value: String) {
    <span style=color:#66d9ef>init</span> {
        require(value.isNotBlank()) { <span style=color:#e6db74>&#34;OrderItemName should not be blank.&#34;</span> }
        require(value.length &lt; <span style=color:#ae81ff>200</span>) { <span style=color:#e6db74>&#34;OrderItemName length should be smaller than 200 but found: </span><span style=color:#e6db74>${value.length}</span><span style=color:#e6db74> with content: </span><span style=color:#e6db74>$value</span><span style=color:#e6db74>.&#34;</span>}
    }
}

<span style=color:#a6e22e>@JvmInline</span>
value <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>OrderItemQuantity</span>(<span style=color:#66d9ef>val</span> value: Int) {
    <span style=color:#66d9ef>init</span> {
        require(value &lt; <span style=color:#ae81ff>0</span>) { <span style=color:#e6db74>&#34;OrderItemQuantity should not be negative but found: </span><span style=color:#e6db74>$value</span><span style=color:#e6db74>.&#34;</span> }
        require(value &gt; <span style=color:#ae81ff>99</span>) { <span style=color:#e6db74>&#34;OrderItemQuantity should not be higher than 99 but found: </span><span style=color:#e6db74>$value</span><span style=color:#e6db74>.&#34;</span> }
    }
}

<span style=color:#a6e22e>@JvmInline</span>
value <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>OrderItemPrice</span>(<span style=color:#66d9ef>val</span> value: BigDecimal) {
    <span style=color:#66d9ef>init</span> {
        require(value &lt; <span style=color:#ae81ff>0</span>) { <span style=color:#e6db74>&#34;OrderItemPrice should not be negative but found: </span><span style=color:#e6db74>$value</span><span style=color:#e6db74>.&#34;</span> }
    }
}
</code></pre></div><p>The new API makes it impossible to create an invalid instance of an <code>Order</code>. It ensures all invariants of an <code>Order</code> are respected during the application&rsquo;s lifetime and reduces corner cases by providing a type-safe API: the function <code>findOrderById</code> knows that you are calling it with an <code>OrderId</code>, it will be a valid <code>UUID</code>.</p>
<h2 id=faq>F.A.Q.</h2>
<ol>
<li>What about the number of classes?</li>
</ol>
<p>Good models often will involve more classes and specific validations - but keep in mind those are already in our code. Remember all those checks to verify if the parameter of <code>findOrderById</code> is valid? Or that <code>InvalidArgumentException</code> when the expected quantity but received a negative number? Now they are explicitly defined in our domain and can be easily found.</p>
<ol start=2>
<li>What about the number of lines of code?</li>
</ol>
<p>It is true that now you need to cover more ground, but it is also true that you reduced the number of corner cases. Before, your tests had to cover if the <code>findOrderByid</code> parameter is valid. Now, the compiler will ensure the parameter is always correct - if the code compiles, you know you are receiving a correct <code>UUID</code>. In the end, you are making safer code and reducing the number of tests you will need.</p>
<ol start=3>
<li>Should I have a class for each property?</li>
</ol>
<p>Probably not. Modeling requires a lot of analysis. You must identify the essential concepts of your domain that must be assertive and ensure those are deep. For that, <a href=https://martinfowler.com/bliki/DomainDrivenDesign.html>Domain-Driven Design</a> might help you.</p>
<h1 id=credits>Credits</h1>
<p>Special credits for <a href=https://www.manning.com/books/secure-by-design>Secure By Design</a> (Chapter 2: Shallow Modeling) and <a href=https://www.amazon.de/-/en/John-Ousterhout/dp/1732102201>A Philosophy of Software Design</a> (Chapter 4: Modules should be deep) where I learnt about Deep and Shallow modeling, both exceptional books.</p>
<p>If you like my posts, follow me on Twitter: <a href=https://twitter.com/marcellogalhard>@marcellogalhard</a></p>
</div>
</article>
<hr>
<div class=post-info>
<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg>
<span class=tag><a href=https://marcellogalhardo.dev/tags/kotlin/>kotlin</a></span>
</p>
<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-folder meta-icon"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"/></svg>
<span class=tag><a href=https://marcellogalhardo.dev/categories/software-development/>software development</a></span>
</p>
<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
769 Words
</p>
<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
2021-10-07 08:02
</p>
</div>
<div class=pagination>
<div class=pagination__title>
<span class=pagination__title-h>Read other posts</span>
<hr>
</div>
<div class=pagination__buttons>
<span class="button next">
<a href=https://marcellogalhardo.dev/posts/2021/03/30/using-compose-beta-on-as-4-1/>
<span class=button__text>Using Compose Beta on AS 4.1</span>
<span class=button__icon>â†’</span>
</a>
</span>
</div>
</div>
</main>
</div>
<footer class=footer>
<div class=footer__inner>
<div class=footer__content>
<span>&copy; 2021</span>
<span><a href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank rel=noopener>CC BY-NC 4.0</a></span><span><a href=https://marcellogalhardo.dev/posts/index.xml target=_blank title=rss><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 20 20" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></span>
</div>
</div>
</footer>
</div>
<script type=text/javascript src=/bundle.min.599099f1f14b78b657d524b28e10e0c5098e7cd46e9c7aed73d577068a276c3ff1bb234cbf29cb313333e83cf411727b43157c91ce5b809e2ffc81664614608e.js integrity="sha512-WZCZ8fFLeLZX1SSyjhDgxQmOfNRunHrtc9V3BoonbD/xuyNMvynLMTMz6Dz0EXJ7QxV8kc5bgJ4v/IFmRhRgjg=="></script>
</body>
</html>