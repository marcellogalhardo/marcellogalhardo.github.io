<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>No Mocks Allowed |</title><meta name=keywords content="android,kotlin"><meta name=description content="Disclaimer: It has been brought to my attention the title can be seen as a click bait. That wasn&rsquo;t my intention and I&rsquo;m sorry. I wanted to reference the Fallout game series and the No Mutants Allowed community.
Testable code plays a crucial role in app development. When we neglect designing code for testability, we often resort to using a mock library (such as Mockito Kotlin, also know as ‚Äúauto-mockers‚Äù) as a mean to achieve test coverage."><meta name=author content><link rel=canonical href=https://marcellogalhardo.dev/posts/no-mocks-allowed/><link crossorigin=anonymous href=/assets/css/stylesheet.fc220c15db4aef0318bbf30adc45d33d4d7c88deff3238b23eb255afdc472ca6.css integrity="sha256-/CIMFdtK7wMYu/MK3EXTPU18iN7/MjiyPrJVr9xHLKY=" rel="preload stylesheet" as=style><link rel=icon href=https://marcellogalhardo.dev/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://marcellogalhardo.dev/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://marcellogalhardo.dev/favicon-32x32.png><link rel=apple-touch-icon href=https://marcellogalhardo.dev/apple-touch-icon.png><link rel=mask-icon href=https://marcellogalhardo.dev/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-7LK7ENB813"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-7LK7ENB813",{anonymize_ip:!1})}</script><meta property="og:title" content="No Mocks Allowed"><meta property="og:description" content="Disclaimer: It has been brought to my attention the title can be seen as a click bait. That wasn&rsquo;t my intention and I&rsquo;m sorry. I wanted to reference the Fallout game series and the No Mutants Allowed community.
Testable code plays a crucial role in app development. When we neglect designing code for testability, we often resort to using a mock library (such as Mockito Kotlin, also know as ‚Äúauto-mockers‚Äù) as a mean to achieve test coverage."><meta property="og:type" content="article"><meta property="og:url" content="https://marcellogalhardo.dev/posts/no-mocks-allowed/"><meta property="og:image" content="https://marcellogalhardo.dev/logo.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-06-28T18:34:00+01:00"><meta property="article:modified_time" content="2023-06-28T18:34:00+01:00"><meta property="og:site_name" content="Marcello Galhardo"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://marcellogalhardo.dev/logo.png"><meta name=twitter:title content="No Mocks Allowed"><meta name=twitter:description content="Disclaimer: It has been brought to my attention the title can be seen as a click bait. That wasn&rsquo;t my intention and I&rsquo;m sorry. I wanted to reference the Fallout game series and the No Mutants Allowed community.
Testable code plays a crucial role in app development. When we neglect designing code for testability, we often resort to using a mock library (such as Mockito Kotlin, also know as ‚Äúauto-mockers‚Äù) as a mean to achieve test coverage."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://marcellogalhardo.dev/posts/"},{"@type":"ListItem","position":2,"name":"No Mocks Allowed","item":"https://marcellogalhardo.dev/posts/no-mocks-allowed/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"No Mocks Allowed","name":"No Mocks Allowed","description":"Disclaimer: It has been brought to my attention the title can be seen as a click bait. That wasn\u0026rsquo;t my intention and I\u0026rsquo;m sorry. I wanted to reference the Fallout game series and the No Mutants Allowed community.\nTestable code plays a crucial role in app development. When we neglect designing code for testability, we often resort to using a mock library (such as Mockito Kotlin, also know as ‚Äúauto-mockers‚Äù) as a mean to achieve test coverage.","keywords":["android","kotlin"],"articleBody":"Disclaimer: It has been brought to my attention the title can be seen as a click bait. That wasn‚Äôt my intention and I‚Äôm sorry. I wanted to reference the Fallout game series and the No Mutants Allowed community.\nTestable code plays a crucial role in app development. When we neglect designing code for testability, we often resort to using a mock library (such as Mockito Kotlin, also know as ‚Äúauto-mockers‚Äù) as a mean to achieve test coverage. Mocks have become a dominant presence in the Android testing ecosystem today. However, there are drawbacks:\nBrittle \u0026 Change-Detector Tests. Tests built with mocks often emphasise implementation details, causing them to break even when the system‚Äôs behaviour remains unchanged. False Sense of Security. High test coverage achieved through extensive mocking, can create a false sense of security. When all dependencies are mocked, we may overlook the fact that no real behavior is being tested. Slow Test Execution1. Reflection and proxies used by mock libraries can lead to sluggish test execution, slowing down the test suite when they increase in quantity. The primary purpose of a mock library is to aid developers in their work. If a codebase relies solely on the presence of mocks for testability, it indicates potential design flaws2.\n‚ÄúThere is a deep synergy between testability and good design. All of the pain that we fell when writing unit tests points at underlying design problems.‚Äù ‚Äì Michael Feathers\nIn this article we‚Äôll dive into how inversion of control using high-order functions or Functional Interfaces can help you achieve testable code without the needs for mocks. The key is to minimize dependencies, ideally reducing them to zero3. We should aim to eliminate dependencies on components like a class that is used throughout the application, or a shared data model that the System Under Test (SUT) doesn‚Äôt own.\nShared understanding: I‚Äôm using the word dependency to refer to a link between two functions, classes or modules. For simplicity, let‚Äôs say it is a direct import.\nNow, let‚Äôs look an example4.\nThe Birthday Feature Suppose we want to introduce a new feature in our app: a listing of employees‚Äô birthdays. The feature has two requirements:\nRetrieve a set of employee records from a database. Display a list of employee records whose birthday falls on the current day. To achieve this, we notice that we can reuse the existing EmployeeRepository shared across the application. We only need to add a new method that filters employees based on their birthdate.\nHere‚Äôs an example of the modified EmployeeRepository:\nclass EmployeeRepository { // New method! suspend fun findEmployeesBornOn(month: Int, day: Int): List = findEmployees() .filter { it.month == month \u0026\u0026 it.day == day } // Old method, reused. suspend fun findEmployees(): List = TODO(\"Load employees from a DB\") // 20+ unrelated methods... } And here is an example of its model:\ndata class Employee( val id: EmployeeId, val name: String, val birthday: LocalDate, // 20+ unrelated properties... ) The view is already implemented, our task is to develop the ViewModel that acts as the bridge between the View and the Repository.\nA naive implementation of the BirthdayViewModel could be as follows:\nclass BirthdayViewModel( repository: EmployeeRepository, ) : ViewModel() { private val _employeeBirthdays = MutableStateFlow(emptyListOf()) val employeeBirthdays = _employeeBirthdays.asStateFlow() init { viewModelScope.launch { val today = LocalDate.now() _employeeBirthdays.value = repository .findEmployeesBornOn(today.month, dayOfMonth = today.dayOfMonth) } } } However, this approach has a few issues:\nBirthdayViewModel depends on a Repository that is used everywhere. If the Repository changes, you need to modify the ViewModel. Except by findEmployeesBornOn, the ViewModel does not use any other method. BirthdayViewModel depends on Employee, a data class it does not own. Except by employeeBirthdays, the ViewModel does not use any other property. EmployeeBirthdayViewModel is unstable. It depends on both EmployeeRepository or Employee, and any change will directly affect it. The usage of LocalDate.now() as a static function makes it challenging to replace during testing. The following diagram provides a visual representation of the relationship between units:\nRather than coupling our feature with the EmployeeRepository and Employee data model, let‚Äôs aim for loose coupling and inversion of control.\nFunction as an Interface Revisiting our requirements, we realize that we only need two things:\nRetrieve the names of employees whose birthday is today. Obtain the current day. Kotlin‚Äôs support for high-order function allows us to treat any function as an interface. This concept enables us to achieve loose coupling5.\nHere‚Äôs an improved version of BirthdayViewModel leveraging a function as an interface6:\nclass BirthdayViewModel( findEmployees: suspend () -\u003e List, now: () -\u003e LocalDate, ) : ViewModel() { private val _employeeBirthdays = MutableStateFlow(emptyListOf()) val employeeBirthdays = _employeeBirthdays.asStateFlow() init { viewModelScope.launch { val today = now() _employeeBirthdays.value = findEmployees() .filter { it -\u003e it.birthday.month == month \u0026\u0026 it.birthday.dayOfMonth == today.dayOfMonth } } } data class Employee(val name: String, val birthday: LocalDate) } // For simplicity, will do all wiring in the factory. // Keep in mind they can be placed in different files and/or Gradle modules. // In a **real world project**, you will want to use Dagger Hilt or Koin Android for doing the wiring and bindings. val BirthdayViewModelFactory: ViewModelProvider.Factory = viewModelFactory { initializer { val application = (this[APPLICATION_KEY] as MyApplication) val repository = application.employeeRepository // Pay attention in the `findEmployees` argument, that is the point of the article. BirthdayViewModel( findEmployees = suspend { // Creates a map from `Repository.findEmployees` to `BirthdayViewModel.Employee`. // Could be a class or high-order function if you want to test it in isolation too. // The implementation here is NOT the point of the article, but a way to show the point. repository .findEmployees() .map { it -\u003e BirthdayViewModel.Employee(it.name, it.birthday) } }, now = LocalDate::now, ) } } This approach offers a few advantages over the previous implementation:\nDuring testing, it becomes straightforward to provide a trivial fake implementation of the findEmployees and now method. BirthdayViewModel has access only to the specific function or property it requires. BirthdayViewModel achieves stability since changes to EmployeeRepository or Employee no longer directly impact it. Both BirthdayViewModel can be tested in isolation without mocks or any complicated architecture, as easy as passing custom functions during your test set-up. The following diagram provides a visual representation of the relationship between units:\nWrapping Up In conclusion, relying excessively on mocks can lead to various pitfalls. By minimizing dependencies, we can achieve more robust and maintainable code. This architectural approach, known as ‚ÄúPorts \u0026 Adapters,‚Äù7 allows for interchangeable adapters, enabling different implementations for production and testing scenarios. Embracing testable design principles ensures that our tests accurately reflect the desired behaviour of the system, fostering a more reliable and efficient software development process.\nIf you want to learn more testing without mocks, here are a few links that can help you in your journey:\nPorts and Adapters Architecture Ports and Adapters / Hexagonal Architecture Testing on the Toilet: Do Not Overuse Mocks Testing on the Toilet: Test Behaviour, Not Implementation Testing on the Toilet: Change-Detector Tests Considered Harmful Jetpack: Do Not Mock Joe Blubaugh: Do Not Mock Fakes Are Great, But Mocks I Hate Testing Without Mocks How to Write Good Tests Frequently Asked Questions That is an article about tests. Why is there, not a single test? Good question. I did plan to write a before and after with tests, but the draft of my article got featured on Android Weekly #557 (?), and I really-really want to play Final Fantasy 16 so I guess this is now the final version.\nThat is interesting but how does it look in practice? One of the article‚Äôs reviewer has been kind, and shared a real use case from their production project:\nShould I do that for everything? Software engineering is about trade-offs. I recommend you to follow the Principle of Least Power: Dependency Injection and build up as your requirements force you to introduce more complexity.\nYou could achieve Ports \u0026 Adapters by introducing an interface to the repository. What is the advantage? True. A single repository interface is less complex. But they are often shared between multiple features creating a coupling between the components of our system. That is not necessary a problem, it is a trade-off.\nCredits Special thanks to Jacob Rein, Stojan Anastasov, Fabricio Vergara, Thiago Souto and Guilherme Baptista proofread review! üîç\nAnd a special thank you to Niek Haarman for the Twitter thread that motivated me to write the blog post.\n‚ÑπÔ∏è To stay up to date with my writing, follow me on Twitter or Mastodon. If you have any questions or I missed something, feel free to reach out to me! ‚ÑπÔ∏è\nThat is a stretch, I know. Any testing framework or library can introduce overhead. It‚Äôs not exclusive to mocks.¬†‚Ü©Ô∏é\nSee How to Write Good Tests for more examples.¬†‚Ü©Ô∏é\nWhile it is important to minimize unnecessary dependencies, in practical scenarios, it is not always possible or even desirable to have zero dependencies.¬†‚Ü©Ô∏é\nBirthday example is inspired by Birthday Greetings Kata.¬†‚Ü©Ô∏é\nAlternatively, you can use a nested Functional Interface instead of a high-order function. That is useful when you need distinguished types, such as when using libraries such as Dagger or Koin.¬†‚Ü©Ô∏é\nI know the example is a too simple, there isn‚Äôt much to test. But I hope you get the point.¬†‚Ü©Ô∏é\nBirthdayViewModel is the system, findEmployeeNamesBornToday is a port, and createFindEmployeeNamesBornToday creates the adapter. Mastering Ports \u0026 Adapters is a powerful skill which can be applied to any level of abstraction (functions, classes, or entire modules!) as you see fit.¬†‚Ü©Ô∏é\n","wordCount":"1574","inLanguage":"en","image":"https://marcellogalhardo.dev/logo.png","datePublished":"2023-06-28T18:34:00+01:00","dateModified":"2023-06-28T18:34:00+01:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://marcellogalhardo.dev/posts/no-mocks-allowed/"},"publisher":{"@type":"Organization","name":"","logo":{"@type":"ImageObject","url":"https://marcellogalhardo.dev/favicon.ico"}}}</script></head><body class=dark id=top><header class=header><nav class=nav><div class=logo><div class=logo-switches></div></div><ul id=menu><li><a href=https://marcellogalhardo.dev/posts/ title=Posts><span>Posts</span></a></li><li><a href=https://marcellogalhardo.dev/talks title=Talks><span>Talks</span></a></li><li><a href=https://marcellogalhardo.dev/about title=About><span>About</span></a></li><li><a href=https://marcellogalhardo.dev/uses title=Uses><span>Uses</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">No Mocks Allowed</h1><div class=post-meta><span title='2023-06-28 18:34:00 +0100 +0100'>June 28, 2023</span></div></header><div class=post-content><p><strong>Disclaimer:</strong> It has been brought to my attention the title can be seen as a click bait. That wasn&rsquo;t my intention and I&rsquo;m sorry. I wanted to reference the Fallout game series and the <a href=https://www.nma-fallout.com/>No Mutants Allowed</a> community.</p><p><img loading=lazy src=/images/no-mutants-allowed.png alt=no-mutants-allowed></p><p><a href=http://xunitpatterns.com/design%20for%20testability.html>Testable code</a> plays a crucial role in app development. When we neglect designing code for testability, we often resort to using a <a href=http://xunitpatterns.com/Mock%20Object.html>mock</a> library (such as Mockito Kotlin, also know as ‚Äúauto-mockers‚Äù) as a mean to achieve test coverage. Mocks have become a dominant presence in the Android testing ecosystem today. However, there are drawbacks:</p><ol><li>Brittle & <a href=https://testing.googleblog.com/2015/01/testing-on-toilet-change-detector-tests.html>Change-Detector Tests</a>. Tests built with mocks often emphasise implementation details, causing them to break even when the system&rsquo;s behaviour remains unchanged.</li><li>False Sense of Security. High test coverage achieved through extensive mocking, can create a false sense of security. When all dependencies are mocked, we may overlook the fact that no real behavior is being tested.</li><li>Slow Test Execution<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>. Reflection and proxies used by mock libraries can lead to sluggish test execution, slowing down the test suite when they increase in quantity.</li></ol><p>The primary purpose of a mock library is to aid developers in their work. If a codebase relies solely on the presence of mocks for testability, it indicates potential design flaws<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup>.</p><blockquote><p>&ldquo;There is a deep synergy between testability and good design. All of the pain that we fell when writing unit tests points at underlying design problems.&rdquo;
&ndash; Michael Feathers</p></blockquote><p>In this article we&rsquo;ll dive into how <a href=https://en.wikipedia.org/wiki/Inversion_of_control>inversion of control</a> using <a href=https://kotlinlang.org/docs/lambdas.html>high-order functions</a> or <a href=https://kotlinlang.org/docs/fun-interfaces.html>Functional Interfaces</a> can help you achieve testable code without the needs for mocks. The key is to minimize dependencies, ideally reducing them to zero<sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup>. We should aim to eliminate dependencies on components like a class that is used <em>throughout the application</em>, or a <em>shared data model</em> that the <a href=http://xunitpatterns.com/SUT.html>System Under Test (SUT)</a> doesn&rsquo;t own.</p><p><strong>Shared understanding:</strong> I&rsquo;m using the word dependency to refer to a link between two functions, classes or modules. For simplicity, let&rsquo;s say it is a direct import.</p><p>Now, let&rsquo;s look an example<sup id=fnref:4><a href=#fn:4 class=footnote-ref role=doc-noteref>4</a></sup>.</p><h3 id=the-birthday-feature>The Birthday Feature<a hidden class=anchor aria-hidden=true href=#the-birthday-feature>#</a></h3><p>Suppose we want to introduce a new feature in our app: a listing of employees&rsquo; birthdays. The feature has two requirements:</p><ol><li>Retrieve a set of employee records from a database.</li><li>Display a list of employee records whose birthday falls on the current day.</li></ol><p>To achieve this, we notice that we can reuse the existing <code>EmployeeRepository</code> shared across the application. We only need to add a new method that filters employees based on their birthdate.</p><p>Here&rsquo;s an example of the modified <code>EmployeeRepository</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>EmployeeRepository</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// New method!
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>suspend</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>findEmployeesBornOn</span>(month: Int, day: Int): List&lt;Employee&gt; =
</span></span><span style=display:flex><span>		findEmployees()
</span></span><span style=display:flex><span>			.filter { <span style=color:#66d9ef>it</span>.month <span style=color:#f92672>==</span> month <span style=color:#f92672>&amp;&amp;</span> <span style=color:#66d9ef>it</span>.day <span style=color:#f92672>==</span> day }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Old method, reused.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>suspend</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>findEmployees</span>(): List&lt;Employee&gt; =
</span></span><span style=display:flex><span>		TODO(<span style=color:#e6db74>&#34;Load employees from a DB&#34;</span>)
</span></span><span style=display:flex><span>		
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 20+ unrelated methods...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><p>And here is an example of its model:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#66d9ef>data</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Employee</span>(
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>val</span> id: EmployeeId,
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>val</span> name: String,
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>val</span> birthday: LocalDate,
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 20+ unrelated properties...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>)
</span></span></code></pre></div><p>The view is already implemented, our task is to develop the <code>ViewModel</code> that acts as the bridge between the <code>View</code> and the <code>Repository</code>.</p><p>A <strong>naive</strong> implementation of the <code>BirthdayViewModel</code> could be as follows:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>BirthdayViewModel</span>(
</span></span><span style=display:flex><span>	repository: EmployeeRepository,
</span></span><span style=display:flex><span>) : ViewModel() {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>private</span> <span style=color:#66d9ef>val</span> _employeeBirthdays = MutableStateFlow(emptyListOf&lt;Employee&gt;())
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>val</span> employeeBirthdays = _employeeBirthdays.asStateFlow()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>init</span> {
</span></span><span style=display:flex><span>		viewModelScope.launch {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>val</span> today = <span style=color:#a6e22e>LocalDate</span>.now()
</span></span><span style=display:flex><span>			_employeeBirthdays.<span style=color:#66d9ef>value</span> = repository
</span></span><span style=display:flex><span>				.findEmployeesBornOn(today.month, dayOfMonth = today.dayOfMonth)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>However, this approach has a few issues:</p><ul><li><code>BirthdayViewModel</code> depends on a <code>Repository</code> that is used everywhere. If the <code>Repository</code> changes, you need to modify the <code>ViewModel</code>. Except by <code>findEmployeesBornOn</code>, the <code>ViewModel</code> does not use any other method.</li><li><code>BirthdayViewModel</code> depends on <code>Employee</code>, a data class it does not own. Except by <code>employeeBirthdays</code>, the <code>ViewModel</code> does not use any other property.</li><li><code>EmployeeBirthdayViewModel</code> is unstable. It depends on both <code>EmployeeRepository</code> or <code>Employee</code>, and any change will directly affect it.</li><li>The usage of <code>LocalDate.now()</code> as a static function makes it challenging to replace during testing.</li></ul><p>The following diagram provides a visual representation of the relationship between units:</p><p><img loading=lazy src=/images/no-mocks-allowed-diagram-before.png alt=no-mocks-allowed-diagram-before></p><p>Rather than coupling our feature with the <code>EmployeeRepository</code> and <code>Employee</code> data model, let&rsquo;s aim for loose coupling and <a href=https://en.wikipedia.org/wiki/Inversion_of_control>inversion of control</a>.</p><h3 id=function-as-an-interface>Function as an Interface<a hidden class=anchor aria-hidden=true href=#function-as-an-interface>#</a></h3><p>Revisiting our requirements, we realize that we only need two things:</p><ol><li>Retrieve the names of employees whose birthday is today.</li><li>Obtain the current day.</li></ol><p>Kotlin&rsquo;s support for <a href=https://kotlinlang.org/docs/lambdas.html>high-order function</a> allows us to treat any <a href=https://fsharpforfunandprofit.com/posts/convenience-functions-as-interfaces/>function as an interface</a>. This concept enables us to achieve loose coupling<sup id=fnref:5><a href=#fn:5 class=footnote-ref role=doc-noteref>5</a></sup>.</p><p>Here&rsquo;s an improved version of <code>BirthdayViewModel</code> leveraging a function as an interface<sup id=fnref:6><a href=#fn:6 class=footnote-ref role=doc-noteref>6</a></sup>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>BirthdayViewModel</span>(
</span></span><span style=display:flex><span>    findEmployees: <span style=color:#66d9ef>suspend</span> () <span style=color:#f92672>-&gt;</span> List&lt;Employee&gt;,
</span></span><span style=display:flex><span>    now: () <span style=color:#f92672>-&gt;</span> LocalDate,
</span></span><span style=display:flex><span>) : ViewModel() {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>private</span> <span style=color:#66d9ef>val</span> _employeeBirthdays = MutableStateFlow(emptyListOf&lt;String&gt;())
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>val</span> employeeBirthdays = _employeeBirthdays.asStateFlow()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>init</span> {
</span></span><span style=display:flex><span>		viewModelScope.launch {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>val</span> today = now()
</span></span><span style=display:flex><span>			_employeeBirthdays.<span style=color:#66d9ef>value</span> = findEmployees()
</span></span><span style=display:flex><span>				.filter { <span style=color:#66d9ef>it</span> <span style=color:#f92672>-&gt;</span> <span style=color:#66d9ef>it</span>.birthday.month <span style=color:#f92672>==</span> month <span style=color:#f92672>&amp;&amp;</span> <span style=color:#66d9ef>it</span>.birthday.dayOfMonth <span style=color:#f92672>==</span> today.dayOfMonth }
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>data</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Employee</span>(<span style=color:#66d9ef>val</span> name: String, <span style=color:#66d9ef>val</span> birthday: LocalDate)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// For simplicity, will do all wiring in the factory.
</span></span></span><span style=display:flex><span><span style=color:#75715e>// Keep in mind they can be placed in different files and/or Gradle modules.
</span></span></span><span style=display:flex><span><span style=color:#75715e>// In a **real world project**, you will want to use Dagger Hilt or Koin Android for doing the wiring and bindings.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>val</span> BirthdayViewModelFactory: <span style=color:#a6e22e>ViewModelProvider</span>.Factory = viewModelFactory {
</span></span><span style=display:flex><span>	initializer {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>val</span> application = (<span style=color:#66d9ef>this</span>[APPLICATION_KEY] <span style=color:#66d9ef>as</span> MyApplication)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>val</span> repository = application.employeeRepository
</span></span><span style=display:flex><span>		<span style=color:#75715e>// Pay attention in the `findEmployees` argument, that is the point of the article.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		BirthdayViewModel(
</span></span><span style=display:flex><span>			findEmployees = <span style=color:#66d9ef>suspend</span> {
</span></span><span style=display:flex><span>				<span style=color:#75715e>// Creates a map from `Repository.findEmployees` to `BirthdayViewModel.Employee`.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>				<span style=color:#75715e>// Could be a class or high-order function if you want to test it in isolation too.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>				<span style=color:#75715e>// The implementation here is NOT the point of the article, but a way to show the point.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>				repository
</span></span><span style=display:flex><span>					.findEmployees()
</span></span><span style=display:flex><span>					.map { <span style=color:#66d9ef>it</span> <span style=color:#f92672>-&gt;</span> <span style=color:#a6e22e>BirthdayViewModel</span>.Employee(<span style=color:#66d9ef>it</span>.name, <span style=color:#66d9ef>it</span>.birthday) }
</span></span><span style=display:flex><span>			},
</span></span><span style=display:flex><span>			now = LocalDate<span style=color:#f92672>::</span>now,
</span></span><span style=display:flex><span>		)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>This approach offers a few advantages over the previous implementation:</p><ul><li>During testing, it becomes straightforward to provide a trivial fake implementation of the <code>findEmployees</code> and <code>now</code> method.</li><li><code>BirthdayViewModel</code> has access only to the specific function or property it requires.</li><li><code>BirthdayViewModel</code> achieves stability since changes to <code>EmployeeRepository</code> or <code>Employee</code> no longer directly impact it.</li><li>Both <code>BirthdayViewModel</code> can be tested in isolation without mocks or any complicated architecture, as easy as passing custom functions during your test set-up.</li></ul><p>The following diagram provides a visual representation of the relationship between units:</p><p><img loading=lazy src=/images/no-mocks-allowed-diagram-after.png alt=no-mocks-allowed-diagram-after></p><h3 id=wrapping-up>Wrapping Up<a hidden class=anchor aria-hidden=true href=#wrapping-up>#</a></h3><p>In conclusion, relying excessively on mocks can lead to various pitfalls. By minimizing dependencies, we can achieve more robust and maintainable code. This architectural approach, known as &ldquo;Ports & Adapters,&rdquo;<sup id=fnref:7><a href=#fn:7 class=footnote-ref role=doc-noteref>7</a></sup> allows for interchangeable adapters, enabling different implementations for production and testing scenarios. Embracing testable design principles ensures that our tests accurately reflect the desired behaviour of the system, fostering a more reliable and efficient software development process.</p><p>If you want to learn more testing without mocks, here are a few links that can help you in your journey:</p><ul><li><a href=http://wiki.c2.com/?PortsAndAdaptersArchitecture>Ports and Adapters Architecture</a></li><li><a href=https://www.dossier-andreas.net/software_architecture/ports_and_adapters.html>Ports and Adapters / Hexagonal Architecture</a></li><li><a href=https://testing.googleblog.com/2013/05/testing-on-toilet-dont-overuse-mocks.html>Testing on the Toilet: Do Not Overuse Mocks</a></li><li><a href=https://testing.googleblog.com/2013/08/testing-on-toilet-test-behavior-not.html>Testing on the Toilet: Test Behaviour, Not Implementation</a></li><li><a href=https://testing.googleblog.com/2015/01/testing-on-toilet-change-detector-tests.html>Testing on the Toilet: Change-Detector Tests Considered Harmful</a></li><li><a href=https://android.googlesource.com/platform/frameworks/support/+/refs/heads/androidx-core-core-role-release/docs/do_not_mock.md>Jetpack: Do Not Mock</a></li><li><a href=https://joeblu.com/blog/2023_06_mocks/>Joe Blubaugh: Do Not Mock</a></li><li><a href=https://www.billjings.com/posts/title/fakes-are-great-but-mocks-i-hate/>Fakes Are Great, But Mocks I Hate</a></li><li><a href=https://www.jamesshore.com/v2/projects/nullables/testing-without-mocks>Testing Without Mocks</a></li><li><a href=https://github.com/mockito/mockito/wiki/How-to-write-good-tests>How to Write Good Tests</a></li></ul><h3 id=frequently-asked-questions>Frequently Asked Questions<a hidden class=anchor aria-hidden=true href=#frequently-asked-questions>#</a></h3><ol><li>That is an article about tests. Why is there, not a single test?</li></ol><p>Good question. I did plan to write a before and after with tests, but the draft of my article got featured on <a href=https://androidweekly.net/issues/issue-577>Android Weekly #557</a> (?), and I <em>really-really want to play Final Fantasy 16</em> so I guess this is now the final version.</p><ol start=2><li>That is interesting but how does it look in practice?</li></ol><p>One of the article&rsquo;s reviewer has been kind, and shared a real use case from their production project:</p><p><img loading=lazy src=/images/no-mocks-allowed-example.jpeg alt="Sign-Up Form"></p><ol start=3><li>Should I do that for everything?</li></ol><p>Software engineering is about trade-offs. I recommend you to follow the <a href=https://www.lihaoyi.com/post/StrategicScalaStylePrincipleofLeastPower.html#dependency-injection>Principle of Least Power: Dependency Injection</a> and build up as your requirements force you to introduce more complexity.</p><ol start=4><li>You could achieve Ports & Adapters by introducing an interface to the repository. What is the advantage?</li></ol><p>True. A single repository interface is less complex. But they are often shared between multiple features creating a coupling between the components of our system. That is not necessary a problem, it is a trade-off.</p><h3 id=credits>Credits<a hidden class=anchor aria-hidden=true href=#credits>#</a></h3><p>Special thanks to <a href=https://twitter.com/deathssouls>Jacob Rein</a>, <a href=https://twitter.com/s_anastasov>Stojan Anastasov</a>, <a href=https://www.linkedin.com/in/fabriciovergal>Fabricio Vergara</a>, <a href=https://twitter.com/othiagosouto>Thiago Souto</a> and <a href=https://github.com/guilhermesgb>Guilherme Baptista</a> proofread review! üîç</p><p>And a special thank you to <a href=https://twitter.com/n_haarman>Niek Haarman</a> for the <a href=https://twitter.com/n_haarman/status/1610908251553501184>Twitter thread</a> that motivated me to write the blog post.</p><hr><blockquote><p>‚ÑπÔ∏è To stay up to date with my writing, follow me on <a href=https://twitter.com/marcellogalhard>Twitter</a> or <a href=http://androiddev.social/@mg>Mastodon</a>. If you have any questions or I missed something, feel free to reach out to me! ‚ÑπÔ∏è</p></blockquote><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>That is a stretch, I know. Any testing framework or library can introduce overhead. It&rsquo;s not exclusive to mocks.&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p>See <a href=https://github.com/mockito/mockito/wiki/How-to-write-good-tests>How to Write Good Tests</a> for more examples.&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:3><p>While it is important to minimize unnecessary dependencies, in practical scenarios, it is not always possible or even desirable to have zero dependencies.&#160;<a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:4><p>Birthday example is inspired by <a href=http://matteo.vaccari.name/blog/archives/154>Birthday Greetings Kata</a>.&#160;<a href=#fnref:4 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:5><p>Alternatively, you can use a nested <a href=https://kotlinlang.org/docs/fun-interfaces.html>Functional Interface</a> instead of a <a href=https://kotlinlang.org/docs/lambdas.html>high-order function</a>. That is useful when you need distinguished types, such as when using libraries such as <a href=https://dagger.dev/>Dagger</a> or <a href=https://insert-koin.io/>Koin</a>.&#160;<a href=#fnref:5 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:6><p>I know the example is a too simple, there isn&rsquo;t much to test. But I hope you get the point.&#160;<a href=#fnref:6 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:7><p><code>BirthdayViewModel</code> is the system, <code>findEmployeeNamesBornToday</code> is a port, and <code>createFindEmployeeNamesBornToday</code> creates the adapter. Mastering Ports & Adapters is a powerful skill which can be applied to <em>any level of abstraction</em> (functions, classes, or entire modules!) as you see fit.&#160;<a href=#fnref:7 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://marcellogalhardo.dev/tags/android/>android</a></li><li><a href=https://marcellogalhardo.dev/tags/kotlin/>kotlin</a></li></ul></footer></article></main><footer class=footer><span>&copy; 2024 <a href=https://marcellogalhardo.dev/></a></span> ¬∑
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script></body></html>