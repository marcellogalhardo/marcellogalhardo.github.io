<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Unit Testing ViewModels | Marcello Galhardo</title>
<meta name=keywords content="android,kotlin"><meta name=description content="Lifecycle 2.9.0-alpha01 introduced ViewModelScenario, a helper that simplifies unit testing for ViewModels.
Why It Matters You can test a ViewModel by simply creating an instance using its constructor in your test code. However, this approach has limitations — there is no straightforward way to:
Trigger ViewModelStore.clear()/ViewModel.onCleared(). Simulate a save and restore instance state. With ViewModelScenario, these scenarios are now easy to test, helping you catch errors related to ViewModel clean-up and saved state."><meta name=author content><link rel=canonical href=https://marcellogalhardo.dev/posts/unit-testing-viewmodels/><link crossorigin=anonymous href=/assets/css/stylesheet.fc220c15db4aef0318bbf30adc45d33d4d7c88deff3238b23eb255afdc472ca6.css integrity="sha256-/CIMFdtK7wMYu/MK3EXTPU18iN7/MjiyPrJVr9xHLKY=" rel="preload stylesheet" as=style><link rel=icon href=https://marcellogalhardo.dev/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://marcellogalhardo.dev/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://marcellogalhardo.dev/favicon-32x32.png><link rel=apple-touch-icon href=https://marcellogalhardo.dev/apple-touch-icon.png><link rel=mask-icon href=https://marcellogalhardo.dev/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://marcellogalhardo.dev/posts/unit-testing-viewmodels/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-7LK7ENB813"></script><script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-7LK7ENB813",{anonymize_ip:!1})}</script><meta property="og:title" content="Unit Testing ViewModels"><meta property="og:description" content="Lifecycle 2.9.0-alpha01 introduced ViewModelScenario, a helper that simplifies unit testing for ViewModels.
Why It Matters You can test a ViewModel by simply creating an instance using its constructor in your test code. However, this approach has limitations — there is no straightforward way to:
Trigger ViewModelStore.clear()/ViewModel.onCleared(). Simulate a save and restore instance state. With ViewModelScenario, these scenarios are now easy to test, helping you catch errors related to ViewModel clean-up and saved state."><meta property="og:type" content="article"><meta property="og:url" content="https://marcellogalhardo.dev/posts/unit-testing-viewmodels/"><meta property="og:image" content="https://marcellogalhardo.dev/logo.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-02-22T22:22:22+22:22"><meta property="article:modified_time" content="2025-02-22T22:22:22+22:22"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://marcellogalhardo.dev/logo.png"><meta name=twitter:title content="Unit Testing ViewModels"><meta name=twitter:description content="Lifecycle 2.9.0-alpha01 introduced ViewModelScenario, a helper that simplifies unit testing for ViewModels.
Why It Matters You can test a ViewModel by simply creating an instance using its constructor in your test code. However, this approach has limitations — there is no straightforward way to:
Trigger ViewModelStore.clear()/ViewModel.onCleared(). Simulate a save and restore instance state. With ViewModelScenario, these scenarios are now easy to test, helping you catch errors related to ViewModel clean-up and saved state."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://marcellogalhardo.dev/posts/"},{"@type":"ListItem","position":2,"name":"Unit Testing ViewModels","item":"https://marcellogalhardo.dev/posts/unit-testing-viewmodels/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Unit Testing ViewModels","name":"Unit Testing ViewModels","description":"Lifecycle 2.9.0-alpha01 introduced ViewModelScenario, a helper that simplifies unit testing for ViewModels.\nWhy It Matters You can test a ViewModel by simply creating an instance using its constructor in your test code. However, this approach has limitations — there is no straightforward way to:\nTrigger ViewModelStore.clear()/ViewModel.onCleared(). Simulate a save and restore instance state. With ViewModelScenario, these scenarios are now easy to test, helping you catch errors related to ViewModel clean-up and saved state.","keywords":["android","kotlin"],"articleBody":"Lifecycle 2.9.0-alpha01 introduced ViewModelScenario, a helper that simplifies unit testing for ViewModels.\nWhy It Matters You can test a ViewModel by simply creating an instance using its constructor in your test code. However, this approach has limitations — there is no straightforward way to:\nTrigger ViewModelStore.clear()/ViewModel.onCleared(). Simulate a save and restore instance state. With ViewModelScenario, these scenarios are now easy to test, helping you catch errors related to ViewModel clean-up and saved state.\nHow to Use First, add the dependency to your Gradle file:\nimplementation(\"androidx.lifecycle:lifecycle-viewmodel-testing:2.9.0-alpha10\") Next, define your ViewModel:\nclass MyViewModel( scope: CoroutineScope, private val handle: SavedStateHandle, ) : ViewModel(scope) { // TODO(\"not implemented\") } Now, write a unit test for your ViewModel using a ViewModelScenario`:\nclass MyViewModelTest { @Test fun testStateRestoration() = runTest { // this: TestScope viewModelScenario { // this: CreationExtras MyViewModel( scope = this@runTest, handle = createSavedStateHandle(), ) }.use { viewModel: MyViewModel -\u003e // Set a ViewModel state. recreate() // Assert state is restored correctly. } } } Test in Details ViewModelScenario.recreate() simulates Android’s state saving and restoring, including parceling (see Save UI states). It verifies that data in SavedStateHandle is correctly persisted. AutoCloseable.use {} ensures ViewModelStore.clear()/ViewModel.onCleared() runs after the test. You can manually call ViewModelScenario.close() to manually trigger clearing. Also, ViewModelScenario is KMP compatible. ℹ️ If you enjoyed the article you might enjoy following me on Bluesky. ℹ️\n","wordCount":"222","inLanguage":"en","image":"https://marcellogalhardo.dev/logo.png","datePublished":"2025-02-22T22:22:22+22:22","dateModified":"2025-02-22T22:22:22+22:22","mainEntityOfPage":{"@type":"WebPage","@id":"https://marcellogalhardo.dev/posts/unit-testing-viewmodels/"},"publisher":{"@type":"Organization","name":"Marcello Galhardo","logo":{"@type":"ImageObject","url":"https://marcellogalhardo.dev/favicon.ico"}}}</script></head><body class=dark id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://marcellogalhardo.dev/ accesskey=h title="Marcello Galhardo (Alt + H)">Marcello Galhardo</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://marcellogalhardo.dev/posts/ title=Posts><span>Posts</span></a></li><li><a href=https://marcellogalhardo.dev/talks title=Talks><span>Talks</span></a></li><li><a href=https://marcellogalhardo.dev/about title=About><span>About</span></a></li><li><a href=https://marcellogalhardo.dev/uses title=Uses><span>Uses</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">Unit Testing ViewModels</h1><div class=post-meta><span title='2025-02-22 22:22:22 +2222 +2222'>February 22, 2025</span></div></header><div class=post-content><p>Lifecycle <a href=https://developer.android.com/jetpack/androidx/releases/lifecycle#2.9.0-alpha01>2.9.0-alpha01</a> introduced <a href="https://cs.android.com/androidx/platform/frameworks/support/+/a775989d0657e5fcbd86bf7949d95a190deb2334:lifecycle/lifecycle-viewmodel-testing/src/commonMain/kotlin/androidx/lifecycle/viewmodel/testing/ViewModelScenario.kt;l=128-131" title="https://cs.android.com/androidx/platform/frameworks/support/+/a775989d0657e5fcbd86bf7949d95a190deb2334:lifecycle/lifecycle-viewmodel-testing/src/commonMain/kotlin/androidx/lifecycle/viewmodel/testing/ViewModelScenario.kt;l=128-131">ViewModelScenario</a>, a helper that simplifies unit testing for <a href="https://cs.android.com/androidx/platform/frameworks/support/+/a775989d0657e5fcbd86bf7949d95a190deb2334:lifecycle/lifecycle-viewmodel/src/commonMain/kotlin/androidx/lifecycle/ViewModel.kt;l=99" title="https://cs.android.com/androidx/platform/frameworks/support/+/a775989d0657e5fcbd86bf7949d95a190deb2334:lifecycle/lifecycle-viewmodel/src/commonMain/kotlin/androidx/lifecycle/ViewModel.kt;l=99">ViewModels</a>.</p><h2 id=why-it-matters>Why It Matters<a hidden class=anchor aria-hidden=true href=#why-it-matters>#</a></h2><p>You can test a <a href="https://cs.android.com/androidx/platform/frameworks/support/+/a775989d0657e5fcbd86bf7949d95a190deb2334:lifecycle/lifecycle-viewmodel/src/commonMain/kotlin/androidx/lifecycle/ViewModel.kt;l=99"><code>ViewModel</code></a> by simply creating an instance using its constructor in your test code. However, this approach has limitations — there is no straightforward way to:</p><ul><li>Trigger <a href="https://cs.android.com/androidx/platform/frameworks/support/+/a775989d0657e5fcbd86bf7949d95a190deb2334:lifecycle/lifecycle-viewmodel/src/commonMain/kotlin/androidx/lifecycle/ViewModelStore.kt;l=56"><code>ViewModelStore.clear()</code></a>/<a href="https://cs.android.com/androidx/platform/frameworks/support/+/a775989d0657e5fcbd86bf7949d95a190deb2334:lifecycle/lifecycle-viewmodel/src/commonMain/kotlin/androidx/lifecycle/ViewModel.kt;l=167"><code>ViewModel.onCleared()</code></a>.</li><li>Simulate a <a href=https://developer.android.com/topic/libraries/architecture/saving-states#onsaveinstancestate>save and restore instance state</a>.</li></ul><p>With <a href="https://cs.android.com/androidx/platform/frameworks/support/+/a775989d0657e5fcbd86bf7949d95a190deb2334:lifecycle/lifecycle-viewmodel-testing/src/commonMain/kotlin/androidx/lifecycle/viewmodel/testing/ViewModelScenario.kt;l=128-131"><code>ViewModelScenario</code></a>, these scenarios are now easy to test, helping you catch errors related to ViewModel clean-up and saved state.</p><h2 id=how-to-use>How to Use<a hidden class=anchor aria-hidden=true href=#how-to-use>#</a></h2><p>First, add the dependency to your Gradle file:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-groovy data-lang=groovy><span style=display:flex><span>implementation<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;androidx.lifecycle:lifecycle-viewmodel-testing:2.9.0-alpha10&#34;</span><span style=color:#f92672>)</span>
</span></span></code></pre></div><p>Next, define your <a href="https://cs.android.com/androidx/platform/frameworks/support/+/a775989d0657e5fcbd86bf7949d95a190deb2334:lifecycle/lifecycle-viewmodel/src/commonMain/kotlin/androidx/lifecycle/ViewModel.kt;l=99"><code>ViewModel</code></a>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MyViewModel</span>(
</span></span><span style=display:flex><span>  scope: CoroutineScope,
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>val</span> handle: SavedStateHandle,
</span></span><span style=display:flex><span>) : ViewModel(scope) {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// TODO(&#34;not implemented&#34;)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><p>Now, write a unit test for your <a href="https://cs.android.com/androidx/platform/frameworks/support/+/a775989d0657e5fcbd86bf7949d95a190deb2334:lifecycle/lifecycle-viewmodel/src/commonMain/kotlin/androidx/lifecycle/ViewModel.kt;l=99"><code>ViewModel</code></a> using a <a href="https://cs.android.com/androidx/platform/frameworks/support/+/a775989d0657e5fcbd86bf7949d95a190deb2334:lifecycle/lifecycle-viewmodel-testing/src/commonMain/kotlin/androidx/lifecycle/viewmodel/testing/ViewModelScenario.kt;l=128-131"><code>ViewModelScenario</code></a>`:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MyViewModelTest</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Test</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>testStateRestoration</span>() = runTest { <span style=color:#75715e>// this: TestScope
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    viewModelScenario { <span style=color:#75715e>// this: CreationExtras
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        MyViewModel(
</span></span><span style=display:flex><span>          scope = <span style=color:#66d9ef>this</span><span style=color:#a6e22e>@runTest</span>,
</span></span><span style=display:flex><span>          handle = createSavedStateHandle(),
</span></span><span style=display:flex><span>        )
</span></span><span style=display:flex><span>    }.use { viewModel: MyViewModel <span style=color:#f92672>-&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Set a ViewModel state.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      recreate()
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Assert state is restored correctly.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=test-in-details>Test in Details<a hidden class=anchor aria-hidden=true href=#test-in-details>#</a></h2><ul><li><a href="https://cs.android.com/androidx/platform/frameworks/support/+/a775989d0657e5fcbd86bf7949d95a190deb2334:lifecycle/lifecycle-viewmodel-testing/src/commonMain/kotlin/androidx/lifecycle/viewmodel/testing/ViewModelScenario.kt;l=92"><code>ViewModelScenario.recreate()</code></a> simulates Android’s state saving and restoring, including parceling (see <a href=https://developer.android.com/topic/libraries/architecture/saving-states#onsaveinstancestate>Save UI states</a>).<ul><li>It verifies that data in <a href="https://cs.android.com/androidx/platform/frameworks/support/+/a775989d0657e5fcbd86bf7949d95a190deb2334:lifecycle/lifecycle-viewmodel-savedstate/src/androidMain/kotlin/androidx/lifecycle/SavedStateHandle.android.kt;l=30"><code>SavedStateHandle</code></a> is correctly persisted.</li></ul></li><li><a href=https://kotlinlang.org/api/core/kotlin-stdlib/kotlin/-auto-closeable.html><code>AutoCloseable.use {}</code></a> ensures <a href="https://cs.android.com/androidx/platform/frameworks/support/+/a775989d0657e5fcbd86bf7949d95a190deb2334:lifecycle/lifecycle-viewmodel/src/commonMain/kotlin/androidx/lifecycle/ViewModelStore.kt;l=56"><code>ViewModelStore.clear()</code></a>/<a href="https://cs.android.com/androidx/platform/frameworks/support/+/a775989d0657e5fcbd86bf7949d95a190deb2334:lifecycle/lifecycle-viewmodel/src/commonMain/kotlin/androidx/lifecycle/ViewModel.kt;l=167"><code>ViewModel.onCleared()</code></a> runs after the test.<ul><li>You can manually call <a href="https://cs.android.com/androidx/platform/frameworks/support/+/a775989d0657e5fcbd86bf7949d95a190deb2334:lifecycle/lifecycle-viewmodel-testing/src/commonMain/kotlin/androidx/lifecycle/viewmodel/testing/ViewModelScenario.kt;l=78-80"><code>ViewModelScenario.close()</code></a> to manually trigger clearing.</li></ul></li><li>Also, <a href="https://cs.android.com/androidx/platform/frameworks/support/+/a775989d0657e5fcbd86bf7949d95a190deb2334:lifecycle/lifecycle-viewmodel-testing/src/commonMain/kotlin/androidx/lifecycle/viewmodel/testing/ViewModelScenario.kt;l=128-131"><code>ViewModelScenario</code></a> is KMP compatible.</li></ul><blockquote><p>ℹ️ If you enjoyed the article you might enjoy following me on <a href=https://bsky.app/profile/marcellogalhardo.dev>Bluesky</a>. ℹ️</p></blockquote></div><footer class=post-footer><ul class=post-tags><li><a href=https://marcellogalhardo.dev/tags/android/>Android</a></li><li><a href=https://marcellogalhardo.dev/tags/kotlin/>Kotlin</a></li></ul></footer></article></main><footer class=footer><span>CC BY-NC 4.0</span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>